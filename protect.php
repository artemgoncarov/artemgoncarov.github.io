<?php
//Каждая неправильная попытка введения купона
function protectEveryCoupon(){
    if (true){
    $trys = 10; //То, что записано в таблице рядом с айпи
    if ($trys>=30) {
        //Заблокировать маркет
    }
    //Записать в таблицу рядом с айпи a+10
    } else {
        //Записать в таблицу айпи и 10
    }
}
//Каждая секунда
function protectEverySecond(){
    $a = 10; //То, что записано в таблице рядом с айпи
    if ($a>0){
        //Записать в таблицу a-1
    }
}